<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
    function getAllProvider(){
        localStorage.clear();
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/provider/lists",
            success: function (data){
                showAllProvider(data)
            }
        })
    }
    function showAllProvider(lists){
        let res = "<tr>\n" +
            "    <td>STT</td>\n" +
            "    <td>Name</td>\n" +
            "</tr>\n";
        for (let i = 0; i < lists.length; i++) {
            let provider = lists[i];
            res += "<tr>\n" +
                "    <td>" + (i +1)       +   "</td>\n" +
                "    <td>" + provider.name  + "</td>\n" +
                `<td><a class="deleteProvider" onclick='deleteProviderById($(this))' href="${provider.id}">Delete</a></td></tr>`;
        }
        document.getElementById("display").innerHTML = "<table>" + res + "</table>";
    }
    function deleteProviderById(a){
        let providerId = a.attr("href");
        $.ajax({
            type: "DELETE",
            url: `http://localhost:8080/provider/${providerId}`,
            success: function (data) {
                a.parent().parent().remove();
            }

        });
        //chặn sự kiện mặc định của thẻ
        event.preventDefault();
    }

    function checkboxService(){
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/serProvider/lists",
            success: function (data){
                document.getElementById("checkbox").innerHTML = createCheckboxService(data);
            }
        })
    }
    function serviceLength(){
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/serProvider/lists",
            success: function (data){
                return data.length;
            }
        })
    }
    function findService(i) {
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/serProvider/" +i,
            success: function (data){
                localStorage.setItem(("serviceId" + i),data.id);
                localStorage.setItem(("serviceName" + i),data.name);
            }
        })
    }
    function createListServiceByCheckbox(){
        for (let i = 1; i <= serviceLength(); i++) {
            let id = "service" + i;
            document.getElementById(id).onclick = function (){
                if (this.checked){
                    findService(i);
                }
            }
        }
    }
    function createCheckboxService(data){
        let checkbox = "";
        for (let i = 0; i < data.length; i++) {
            let name = data[i].name;
            checkbox += "<input type=\"checkbox\" id=\"service" + (i+1) +"\"" + "value=\"" + data[i].id + "\">"+name;
        }
        return checkbox;
    }
    function showFormAddProvider(userid){

        let form = "<input type=\"text\" id=\"name\" placeholder=\"Ho va ten\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"age\" placeholder=\"tuoi\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"city\" placeholder=\"thanh pho dang sinh song\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"gender\" placeholder=\"gioi tinh\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"nationality\" placeholder=\"quoc tich\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"hobby\" placeholder=\"so thich\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"height\" placeholder=\"chieu cao\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"weight\" placeholder=\"can nang\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"description\" placeholder=\"mo ta them\">\n" +
            "<br>" +
            "<input type=\"text\" id=\"facebook\" placeholder=\"link facebook\">\n" +
            "<br>" +
            "<input type=\"number\" id=\"price\"placeholder=\"gia thue theo gio\">\n" +
            "<br>" +
            "<p>Chon dich vu:</p>" +
            "<div id=\"checkbox\"></div>" +
            "<br>" +
            "<button onclick=\"saveProvider()\">Save</button>" +
            "<br>" +
            "<input type=\"hidden\" id=\"userid\" value=\"" + userid + "\">\n"
            checkboxService();

        document.getElementById("display").innerHTML = form;
    }
    function findUser(userid){
        $.ajax({
            type: "GET",
            url: "http://localhost:8080/user/"+userid,
            success: function (data){
              localStorage.setItem("userId", data.id);
                localStorage.setItem("userName", data.name);
                localStorage.setItem("userPassword", data.password);
                localStorage.setItem("userEmail", data.email);
                localStorage.setItem("userPhone", data.phone);
                localStorage.setItem("userJoindate", data.joinDate);
                localStorage.setItem("userRoleId", data.role.id);
                localStorage.setItem("userRoleName", data.role.name);
                localStorage.setItem("userVip", data.vip);
            }
        })
    }

    function saveProvider(){
        let userid = document.getElementById("userid").value;
        createListServiceByCheckbox();
        findUser(userid);
        let service = "";
        for (let i = 1; i <= serviceLength(); i++) {
            let max = serviceLength();
            let key = ("service" + i);
            if (localStorage.getItem(key) != null){
               let result = localStorage.getItem(key);
                if (i < max){
                    service += "{\n" +
                        "            \"id\":" + result[1] + ",\n" +
                        "            \"name\": \""+ result[2] +"\"\n" +
                        "        },"
                    max -= 1;
                }
                else if (i = max){
                        service += "{\n" +
                            "            \"id\":" + result[1] + ",\n" +
                            "            \"name\": \""+ result[2] +"\"\n" +
                            "        }"
                        break;
                }
            }
        }
        let serviceDone = "[\n" + service + "\n]";
        let userArray = localStorage.getItem("user");
        let user = "{\n" +
            "        \"id\":"+ userArray[0] +",\n" +
            "        \"userName\": \""+ userArray[1] + "\",\n" +
            "        \"password\": \""+ userArray[2] + "\",\n" +
            "        \"email\": \""+ userArray[3] + "\",\n" +
            "        \"phone\": \""+ userArray[4] + "\",\n" +
            "        \"joinDate\": \""+ userArray[5] + "\",\n" +
            "        \"role\": {\n" +
            "            \"id\": \""+ userArray[6] + "\",\n" +
            "            \"name\": \""+ userArray[7] + "\",\n" +
            "        \"vip\": \""+ userArray[8] + "\",\n" +
            "        }"
        let hobby = document.getElementById("hobby").value;
        let name = document.getElementById("name").value;
        let age = document.getElementById("age").value;
        let city = document.getElementById("city").value;
        let gender = document.getElementById("gender").value;
        let nationality = document.getElementById("nationality").value;
        let height = document.getElementById("height").value;
        let weight = document.getElementById("weight").value;
        let description = document.getElementById("description").value;
        let facebook = document.getElementById("facebook").value;
        let price = document.getElementById("price").value;
        let nal = {
            hobby: hobby,
            name: name,
            age: age,
            city: city,
            gender: gender,
            nationality: nationality,
            height: height,
            weight: weight,
            description: description,
            facebook: facebook,
            price: price,
            service : serviceDone,
            status: "active",
            hasBeenHired: 0,
            view: 0,
            user : user
        }
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
            },
            type: "POST",
            url: "http://localhost:8080/provider/save",
            data: JSON.stringify(nal),
            success: getAllProvider(),

            error: function (err){
                console.log(err)
            }
        })
    }
    function test() {
        console.log(localStorage.getItem("user"));
    }
    </script>
</head>
<body onload="getAllProvider()">
<button onclick="showFormAddProvider(1)">Add Provider</button>
    <div id="display"></div>
<p>Đây là Provider</p>
</body>
</html>